///symphony

pub def input() U16 {
    asm symphony {
        in r1
    }
    return <U16>0
}

pub def output(a: U16) {
    asm symphony {
        out r1
    }
}

/** REFERENCE COUNTING **/

/* The Rc pointer points to the first element of an array or a string
 * The -1'st element is the array's/string's length, and the -2'nd element is the Rc counter
 */
type Rc U16

pub def increment_rc(a: Rc) {
    var counter = get_rc_counter(a)
    counter += 1
    save_rc_counter(a, counter)
}

pub def decrement_rc(a: Rc) {
    var counter = get_rc_counter(a)
    counter -= 1
    save_rc_counter(a, counter)

    // if the rc counter is 0, we deallocate it
    if (counter == 0) {
        free(a)
    }
}

def get_rc_counter(a: Rc) U16 {
    // Assuming counter is at index -2
    return (<[U16]>a)[-2]
}

def save_rc_counter(a: Rc, value: U16) {
    // Assuming counter is at index -2
    (<[U16]>a)[-2] = value
}

/** MEMORY ALLOCATOR **/

const HEAP_ALLOCATOR_START = <U16>0x2000
const HEAP_ALLOCATOR_END = <U16>0xE000

pub def init_allocator() {
    var heap = (<[U16]>HEAP_ALLOCATOR_START)
    heap[0] = 1
    heap[1] = HEAP_ALLOCATOR_END - HEAP_ALLOCATOR_START
    heap[HEAP_ALLOCATOR_END - HEAP_ALLOCATOR_START - 1] = 0
}

pub def malloc(size: U16) Rc {
    var heap = (<[U16]>HEAP_ALLOCATOR_START)
    var block_end_pointer = 0
    while (true) {
        var next_block_pointer = heap[block_end_pointer]
        if (next_block_pointer == 0) {
            return <Rc> 0
        }

        var block_length = heap[next_block_pointer]
        if (block_length == size) {
            heap[block_end_pointer] = next_block_pointer + block_length - 1
            return <Rc> (HEAP_ALLOCATOR_START + next_block_pointer + next_block_pointer)
        } elif (block_length > size + 1) {
            var new_next_block_pointer = next_block_pointer + size - 1
            heap[block_end_pointer] = new_next_block_pointer
            heap[new_next_block_pointer] = block_length - size
            return <Rc> (HEAP_ALLOCATOR_START + next_block_pointer + next_block_pointer)
        }

        block_end_pointer += block_length - 1
    }
    return <Rc> 0
}

pub def free(a: Rc) {
    
}

type MyOwnBool Enum[yes, no, notfound]